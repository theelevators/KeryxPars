@using KeryxPars.MessageViewer.Core.Models
@using KeryxPars.HL7.Definitions
@using ValidationSeverity = KeryxPars.HL7.Contracts.ValidationSeverity

<!-- Render modal at body level to escape parent containers -->
<div class="modal-backdrop" @onclick="Cancel">
    <div class="modal-dialog modal-lg rule-builder-modal" @onclick:stopPropagation>
        <div class="modal-content">
            <div class="modal-header">
            <h4>
                <span class="bi bi-plus-circle"></span>
                @(ExistingRule != null ? "Edit Rule" : "Create Validation Rule")
            </h4>
            <button class="btn-close" @onclick="Cancel">
                <span class="bi bi-x-lg"></span>
            </button>
        </div>

        <div class="modal-body">
            <!-- Step Indicator -->
            <div class="wizard-steps">
                <div class="step @(currentStep == 1 ? "active" : "") @(currentStep > 1 ? "completed" : "")">
                    <div class="step-number">1</div>
                    <div class="step-label">Target</div>
                </div>
                <div class="step @(currentStep == 2 ? "active" : "") @(currentStep > 2 ? "completed" : "")">
                    <div class="step-number">2</div>
                    <div class="step-label">Rule Type</div>
                </div>
                <div class="step @(currentStep == 3 ? "active" : "")">
                    <div class="step-number">3</div>
                    <div class="step-label">Configure</div>
                </div>
            </div>

            <!-- Step 1: Select Target -->
            @if (currentStep == 1)
            {
                <div class="wizard-step">
                    <h5>What do you want to validate?</h5>
                    <SegmentPicker @bind-SelectedSegment="selectedSegment" 
                                  @bind-SelectedField="selectedField"
                                  Message="@CurrentMessage" />
                </div>
            }

            <!-- Step 2: Choose Rule Type -->
            @if (currentStep == 2)
            {
                <div class="wizard-step">
                    <h5>What type of validation?</h5>
                    <RuleTypePicker @bind-SelectedType="selectedRuleType" 
                                   IsFieldLevel="@(selectedField.HasValue)" />
                </div>
            }

            <!-- Step 3: Configure Rule -->
            @if (currentStep == 3)
            {
                <div class="wizard-step">
                    <h5>Configure Rule Details</h5>
                    <RuleConfigEditor RuleType="@selectedRuleType" 
                                     Config="@ruleConfig"
                                     ConfigChanged="@HandleConfigChanged"
                                     Severity="@severity"
                                     SeverityChanged="@HandleSeverityChanged"
                                     CustomMessage="@customMessage"
                                     CustomMessageChanged="@HandleCustomMessageChanged"
                                     SegmentId="@selectedSegment"
                                     FieldIndex="@selectedField" />
                    
                    <!-- Live Preview -->
                    <div class="rule-preview">
                        <h6><span class="bi bi-eye"></span> Preview</h6>
                        <RuleCard Rule="@GetPreviewRule()" IsPreview="true" />
                    </div>
                </div>
            }
        </div>

        <div class="modal-footer">
            @if (currentStep > 1)
            {
                <button class="btn btn-secondary" @onclick="PreviousStep">
                    <span class="bi bi-arrow-left"></span>
                    Back
                </button>
            }
            
            @if (currentStep < 3)
            {
                <button class="btn btn-primary" @onclick="NextStep" disabled="@(!CanProceed())">
                    Next
                    <span class="bi bi-arrow-right"></span>
                </button>
            }
            else
            {
                <button class="btn btn-success" @onclick="SaveRule">
                    <span class="bi bi-check-circle"></span>
                    @(ExistingRule != null ? "Update Rule" : "Create Rule")
                </button>
            }
            
            <button class="btn btn-outline-secondary" @onclick="Cancel">Cancel</button>
        </div>
    </div>
</div>
</div>

@code {
[Parameter] public RuleDefinition? ExistingRule { get; set; }
[Parameter] public EventCallback<RuleDefinition> OnSave { get; set; }
[Parameter] public EventCallback OnCancel { get; set; }
[Parameter] public HL7ComprehensiveMessage? CurrentMessage { get; set; }
    
    private int currentStep = 1;
    private string? selectedSegment;
    private int? selectedField;
    private RuleType selectedRuleType;
    private Dictionary<string, object> ruleConfig = new();
    private ValidationSeverity severity = ValidationSeverity.Error;
    private string customMessage = "";

    protected override void OnParametersSet()
    {
        if (ExistingRule != null)
        {
            selectedSegment = ExistingRule.SegmentId;
            selectedField = ExistingRule.FieldIndex;
            selectedRuleType = ExistingRule.Type;
            ruleConfig = new Dictionary<string, object>(ExistingRule.Config);
            severity = ExistingRule.Severity;
            customMessage = ExistingRule.CustomMessage ?? "";
        }
    }
    
    private void NextStep() => currentStep++;
    private void PreviousStep() => currentStep--;
    
    private void HandleConfigChanged(Dictionary<string, object> config)
    {
        ruleConfig = config;
    }
    
    private void HandleSeverityChanged(ValidationSeverity newSeverity)
    {
        severity = newSeverity;
    }
    
    private void HandleCustomMessageChanged(string message)
    {
        customMessage = message;
    }
    
    private bool CanProceed() => currentStep switch
    {
        1 => !string.IsNullOrEmpty(selectedSegment),
        2 => selectedRuleType != RuleType.None,
        _ => true
    };
    
    private async Task SaveRule()
    {
        var rule = new RuleDefinition
        {
            Id = ExistingRule?.Id ?? Guid.NewGuid(),
            SegmentId = selectedSegment!,
            FieldIndex = selectedRuleType == RuleType.RequiredSegment ? null : selectedField,
            Type = selectedRuleType,
            Config = ruleConfig,
            Severity = severity,
            CustomMessage = string.IsNullOrWhiteSpace(customMessage) ? null : customMessage,
            CreatedAt = ExistingRule?.CreatedAt ?? DateTime.UtcNow
        };
        
        await OnSave.InvokeAsync(rule);
    }
    
    private async Task Cancel() => await OnCancel.InvokeAsync();

    private RuleDefinition GetPreviewRule() => new()
    {
        SegmentId = selectedSegment ?? "MSH",
        FieldIndex = selectedRuleType == RuleType.RequiredSegment ? null : selectedField,
        Type = selectedRuleType,
        Config = ruleConfig,
        Severity = severity,
        CustomMessage = customMessage,
        IsEnabled = true
    };
}
