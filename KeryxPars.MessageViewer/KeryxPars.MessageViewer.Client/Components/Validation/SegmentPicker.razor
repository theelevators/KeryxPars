@using KeryxPars.HL7.Definitions
@using KeryxPars.HL7.Contracts
@using System.Reflection

<div class="segment-picker">
    <div class="picker-mode">
        <button class="mode-btn @(mode == "list" ? "active" : "")" 
                @onclick='() => mode = "list"'>
            <span class="bi bi-list-ul"></span> List View
        </button>
        <button class="mode-btn @(mode == "visual" ? "active" : "")" 
                @onclick='() => mode = "visual"'
                disabled="@(Message == null)">
            <span class="bi bi-eye"></span> Visual View
        </button>
    </div>

    @if (mode == "list")
    {
        <div class="segment-list">
            <input type="text" 
                   class="form-control search-input" 
                   @bind="searchText" 
                   @bind:event="oninput"
                   placeholder="Search segments... (e.g., MSH, PID, ORC)">
            
            <div class="segment-options">
                @foreach (var segment in GetFilteredSegments())
                {
                    <div class="segment-option @(SelectedSegment == segment ? "selected" : "")"
                         @onclick="() => SelectSegment(segment)">
                        <div class="segment-header">
                            <strong>@segment</strong>
                            <span class="segment-name">@GetSegmentDescription(segment)</span>
                        </div>
                        
                        @if (SelectedSegment == segment)
                        {
                            <div class="field-picker">
                                <small>Select Field (optional):</small>
                                <div class="field-options">
                                    @for (int i = 1; i <= GetFieldCount(segment); i++)
                                    {
                                        var fieldIndex = i;
                                        <div class="field-option @(SelectedField == fieldIndex ? "selected" : "")"
                                             @onclick="() => SelectField(fieldIndex)"
                                             @onclick:stopPropagation>
                                            <span class="field-index">[@fieldIndex]</span>
                                            <span class="field-name">Field @fieldIndex</span>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    }
    else if (Message != null)
    {
        <div class="visual-picker">
            <div class="message-structure">
                @foreach (var (segment, index) in GetMessageSegments())
                {
                    var segmentId = segment.SegmentId;
                    <div class="segment-visual @(SelectedSegment == segmentId ? "selected" : "")"
                         @onclick="() => SelectSegment(segmentId)">
                        <div class="segment-badge">@segmentId</div>
                        <div class="segment-preview">@GetSegmentPreview(segment)</div>
                        
                        @if (SelectedSegment == segmentId)
                        {
                            <div class="field-grid">
                                @{
                                    var fields = GetSegmentFields(segment);
                                    for (int i = 0; i < fields.Count && i < 20; i++) // Limit to first 20 fields
                                    {
                                        var fieldIndex = i + 1;
                                        var fieldValue = fields[i];
                                        <div class="field-box @(SelectedField == fieldIndex ? "selected" : "")"
                                             @onclick="() => SelectField(fieldIndex)"
                                             @onclick:stopPropagation
                                             title="Field @fieldIndex">
                                            <div class="field-num">@fieldIndex</div>
                                            <div class="field-value">@GetTruncatedValue(fieldValue)</div>
                                        </div>
                                    }
                                }
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    }
</div>

@code {
[Parameter] public string? SelectedSegment { get; set; }
[Parameter] public EventCallback<string?> SelectedSegmentChanged { get; set; }
[Parameter] public int? SelectedField { get; set; }
[Parameter] public EventCallback<int?> SelectedFieldChanged { get; set; }
[Parameter] public HL7ComprehensiveMessage? Message { get; set; }
    
    private string mode = "list";
    private string searchText = "";

    private static readonly string[] CommonSegments = 
    [
        "MSH", "EVN", "PID", "PD1", "NK1", "PV1", "PV2",
        "ORC", "OBR", "OBX", "NTE",
        "RXE", "RXR", "RXA", "RXC", "RXD", "RXG",
        "DG1", "PR1", "GT1", "IN1", "IN2",
        "FT1", "SCH", "AIP", "AIS", "AIL",
        "AL1", "ACC", "MRG", "ERR", "QRD", "QRF"
    ];

    private List<string> GetFilteredSegments()
    {
        if (string.IsNullOrWhiteSpace(searchText))
            return CommonSegments.ToList();
        
        return CommonSegments
            .Where(s => s.Contains(searchText, StringComparison.OrdinalIgnoreCase))
            .ToList();
    }

    private async Task SelectSegment(string segmentId)
    {
        SelectedSegment = segmentId;
        SelectedField = null; // Reset field selection
        await SelectedSegmentChanged.InvokeAsync(segmentId);
    }
    
    private async Task SelectField(int fieldIndex)
    {
        SelectedField = fieldIndex;
        await SelectedFieldChanged.InvokeAsync(fieldIndex);
    }

    private string GetSegmentDescription(string segmentId) => segmentId switch
    {
        "MSH" => "Message Header",
        "EVN" => "Event Type",
        "PID" => "Patient Identification",
        "PD1" => "Patient Additional Demographic",
        "NK1" => "Next of Kin",
        "PV1" => "Patient Visit",
        "PV2" => "Patient Visit - Additional Info",
        "ORC" => "Common Order",
        "OBR" => "Observation Request",
        "OBX" => "Observation Result",
        "NTE" => "Notes and Comments",
        "RXE" => "Pharmacy/Treatment Encoded Order",
        "RXR" => "Pharmacy/Treatment Route",
        "RXA" => "Pharmacy/Treatment Administration",
        "RXC" => "Pharmacy/Treatment Component",
        "RXD" => "Pharmacy/Treatment Dispense",
        "RXG" => "Pharmacy/Treatment Give",
        "DG1" => "Diagnosis",
        "PR1" => "Procedures",
        "GT1" => "Guarantor",
        "IN1" => "Insurance",
        "IN2" => "Insurance Additional Info",
        "FT1" => "Financial Transaction",
        "SCH" => "Schedule Activity Information",
        "AL1" => "Patient Allergy Information",
        _ => segmentId
    };

    private int GetFieldCount(string segmentId) => segmentId switch
    {
        "MSH" => 21,
        "PID" => 30,
        "ORC" => 31,
        "OBR" => 50,
        "OBX" => 25,
        "RXE" => 44,
        _ => 20
    };

    private List<(ISegment segment, int index)> GetMessageSegments()
    {
        if (Message == null)
            return [];

        var segments = new List<(ISegment, int)>();
        var properties = Message.GetType().GetProperties(BindingFlags.Public | BindingFlags.Instance);

        int index = 0;
        foreach (var prop in properties)
        {
            var value = prop.GetValue(Message);
            if (value is ISegment segment)
            {
                segments.Add((segment, index++));
            }
            else if (value is Array arr)
            {
                foreach (var item in arr)
                {
                    if (item is ISegment segmentItem)
                    {
                        segments.Add((segmentItem, index++));
                    }
                }
            }
        }

        return segments;
    }

    private string GetSegmentPreview(ISegment segment)
    {
        var fields = GetSegmentFields(segment);
        if (fields.Count == 0)
            return "(empty)";
        
        return string.Join(" | ", fields.Take(3).Select(GetTruncatedValue));
    }

    private List<object?> GetSegmentFields(ISegment segment)
    {
        var properties = segment.GetType()
            .GetProperties(BindingFlags.Public | BindingFlags.Instance)
            .Where(p => p.Name != "SegmentId" && p.Name != "SegmentType")
            .ToArray();

        return properties.Select(p => p.GetValue(segment)).ToList();
    }

    private string GetTruncatedValue(object? value, int maxLength = 15)
    {
        var str = value?.ToString() ?? "";
        if (string.IsNullOrWhiteSpace(str))
            return "(empty)";
        
        return str.Length > maxLength ? str.Substring(0, maxLength) + "..." : str;
    }
}
