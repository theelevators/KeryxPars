@using KeryxPars.MessageViewer.Core.Models
@using KeryxPars.MessageViewer.Client.Extensions

<div class="patient-summary">
    @if (Result.Message != null)
    {
        @if (Result.Message.Pid != null)
        {
            var pidFields = Result.Message.Pid.GetValues();
            
            <div class="patient-header">
                <div class="patient-identity">
                    <h3>
                        <span class="bi bi-person-circle me-2"></span>
                        @GetFieldValue(pidFields, 5, "Unknown Patient")
                    </h3>
                    <div class="patient-demographics">
                        <span class="demographic-item">
                            <strong>DOB:</strong> @FormatDate(GetFieldValue(pidFields, 7))
                        </span>
                        <span class="demographic-item">
                            <strong>Sex:</strong> @GetFieldValue(pidFields, 8, "Unknown")
                        </span>
                        <span class="demographic-item">
                            <strong>MRN:</strong> @GetFieldValue(pidFields, 3, "N/A")
                        </span>
                    </div>
                </div>
            </div>

            <div class="patient-contact">
                <h4><span class="bi bi-telephone me-2"></span>Contact Information</h4>
                <div class="contact-details">
                    @{
                        var address = GetFieldValue(pidFields, 11);
                        if (!string.IsNullOrWhiteSpace(address))
                        {
                            <div class="detail-row">
                                <span class="detail-label">Address:</span>
                                <span class="detail-value">@address.Replace("^", " ")</span>
                            </div>
                        }
                        
                        var homePhone = GetFieldValue(pidFields, 13);
                        if (!string.IsNullOrWhiteSpace(homePhone))
                        {
                            <div class="detail-row">
                                <span class="detail-label">Home Phone:</span>
                                <span class="detail-value">@homePhone</span>
                            </div>
                        }
                        
                        var businessPhone = GetFieldValue(pidFields, 14);
                        if (!string.IsNullOrWhiteSpace(businessPhone))
                        {
                            <div class="detail-row">
                                <span class="detail-label">Business Phone:</span>
                                <span class="detail-value">@businessPhone</span>
                            </div>
                        }
                    }
                </div>
            </div>
        }

        @if (Result.Message.Pv1 != null && !IsEmpty(Result.Message.Pv1))
        {
            var pv1Fields = Result.Message.Pv1.GetValues();
            
            <div class="visit-info">
                <h4><span class="bi bi-building me-2"></span>Visit Information</h4>
                <div class="visit-details">
                    <div class="detail-row">
                        <span class="detail-label">Patient Class:</span>
                        <span class="detail-value">@GetFieldValue(pv1Fields, 2, "Unknown")</span>
                    </div>
                    @{
                        var location = GetFieldValue(pv1Fields, 3);
                        if (!string.IsNullOrWhiteSpace(location))
                        {
                            <div class="detail-row">
                                <span class="detail-label">Location:</span>
                                <span class="detail-value">@location</span>
                            </div>
                        }
                        
                        var visitNumber = GetFieldValue(pv1Fields, 19);
                        if (!string.IsNullOrWhiteSpace(visitNumber))
                        {
                            <div class="detail-row">
                                <span class="detail-label">Visit Number:</span>
                                <span class="detail-value">@visitNumber</span>
                            </div>
                        }
                        
                        var admissionType = GetFieldValue(pv1Fields, 4);
                        if (!string.IsNullOrWhiteSpace(admissionType))
                        {
                            <div class="detail-row">
                                <span class="detail-label">Admission Type:</span>
                                <span class="detail-value">@admissionType</span>
                            </div>
                        }
                    }
                </div>
            </div>
        }

        @if (Result.Message.Allergies.Any(a => !IsEmpty(a)))
        {
            <div class="allergies-section alert-section">
                <h4><span class="bi bi-exclamation-triangle me-2"></span>Allergies</h4>
                <div class="allergies-list">
                    @foreach (var allergy in Result.Message.Allergies.Where(a => !IsEmpty(a)))
                    {
                        var allergyFields = allergy.GetValues();
                        <div class="allergy-item alert-item">
                            <span class="allergy-icon bi bi-circle-fill"></span>
                            <div class="allergy-details">
                                <strong>@GetFieldValue(allergyFields, 3, "Unknown Allergen")</strong>
                                @{
                                    var allergyType = GetFieldValue(allergyFields, 2);
                                    if (!string.IsNullOrWhiteSpace(allergyType))
                                    {
                                        <span class="allergy-type">Type: @allergyType</span>
                                    }
                                    
                                    var severity = GetFieldValue(allergyFields, 4);
                                    if (!string.IsNullOrWhiteSpace(severity))
                                    {
                                        <span class="allergy-severity">Severity: @severity</span>
                                    }
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>
        }

        @if (Result.Message.Diagnoses.Any(d => !IsEmpty(d)))
        {
            <div class="diagnoses-section">
                <h4><span class="bi bi-clipboard-pulse me-2"></span>Diagnoses</h4>
                <div class="diagnoses-list">
                    @foreach (var diagnosis in Result.Message.Diagnoses.Where(d => !IsEmpty(d)))
                    {
                        var diagFields = diagnosis.GetValues();
                        <div class="diagnosis-item">
                            <div class="diagnosis-header">
                                <span class="diagnosis-code">@GetFieldValue(diagFields, 3)</span>
                            </div>
                            @{
                                var description = GetFieldValue(diagFields, 4);
                                if (!string.IsNullOrWhiteSpace(description))
                                {
                                    <div class="diagnosis-description">@description</div>
                                }
                                
                                var codingMethod = GetFieldValue(diagFields, 2);
                                if (!string.IsNullOrWhiteSpace(codingMethod))
                                {
                                    <div class="diagnosis-meta">
                                        <span>Coding Method: @codingMethod</span>
                                    </div>
                                }
                            }
                        </div>
                    }
                </div>
            </div>
        }

        @if (Result.Message.Orders.Any())
        {
            <div class="orders-section">
                <h4>
                    <span class="bi bi-prescription2 me-2"></span>Orders
                    <span class="order-count-badge">@Result.Message.Orders.Count</span>
                </h4>
                <div class="orders-list">
                    @foreach (var order in Result.Message.Orders.Select((o, index) => new { Order = o, Index = index + 1 }))
                    {
                        <div class="order-item">
                            <div class="order-header">
                                <span class="order-number">#@order.Index</span>
                                <span class="order-type-badge">@order.Order.OrderType</span>
                                @if (order.Order.PrimarySegment != null)
                                {
                                    var primaryFields = order.Order.PrimarySegment.GetValues();
                                    var orderControl = GetFieldValue(primaryFields, 1);
                                    if (!string.IsNullOrWhiteSpace(orderControl))
                                    {
                                        <span class="order-control">@orderControl</span>
                                    }
                                    
                                    // Show Placer/Filler order numbers if available (ORC.2, ORC.3)
                                    var placerOrder = GetFieldValue(primaryFields, 2);
                                    var fillerOrder = GetFieldValue(primaryFields, 3);
                                    if (!string.IsNullOrWhiteSpace(placerOrder) || !string.IsNullOrWhiteSpace(fillerOrder))
                                    {
                                        <span class="order-ids">
                                            @if (!string.IsNullOrWhiteSpace(placerOrder))
                                            {
                                                <span class="order-id">Placer: @placerOrder</span>
                                            }
                                            @if (!string.IsNullOrWhiteSpace(fillerOrder))
                                            {
                                                <span class="order-id">Filler: @fillerOrder</span>
                                            }
                                        </span>
                                    }
                                }
                            </div>
                            
                            @* Detail Segments (RXE, OBR, etc.) *@
                            @if (order.Order.DetailSegments.Any())
                            {
                                <div class="order-details">
                                    @foreach (var detail in order.Order.DetailSegments)
                                    {
                                        var detailFields = detail.Value.GetValues();
                                        <div class="order-detail-segment">
                                            <div class="segment-header">
                                                <span class="segment-badge">@detail.Key</span>
                                                <span class="segment-name">@GetSegmentName(detail.Key)</span>
                                            </div>
                                            <div class="segment-fields">
                                                @{
                                                    var importantFields = GetImportantFields(detail.Key, detailFields);
                                                    foreach (var field in importantFields)
                                                    {
                                                        <div class="field-item">
                                                            <span class="field-label">@field.Label:</span>
                                                            <span class="field-value">@field.Value</span>
                                                        </div>
                                                    }
                                                }
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                            
                            @* Repeatable Segments (OBX, NTE, etc.) *@
                            @if (order.Order.RepeatableSegments.Any())
                            {
                                <div class="order-repeatables">
                                    @foreach (var repeatableGroup in order.Order.RepeatableSegments)
                                    {
                                        <div class="repeatable-group">
                                            <div class="repeatable-header">
                                                <span class="segment-badge">@repeatableGroup.Key</span>
                                                <span class="segment-count">@repeatableGroup.Value.Count item@(repeatableGroup.Value.Count != 1 ? "s" : "")</span>
                                            </div>
                                            @foreach (var segment in repeatableGroup.Value)
                                            {
                                                var fields = segment.GetValues();
                                                var importantFields = GetImportantFields(repeatableGroup.Key, fields);
                                                if (importantFields.Any())
                                                {
                                                    <div class="repeatable-item">
                                                        @foreach (var field in importantFields)
                                                        {
                                                            <div class="field-item">
                                                                <span class="field-label">@field.Label:</span>
                                                                <span class="field-value">@field.Value</span>
                                                            </div>
                                                        }
                                                    </div>
                                                }
                                            }
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>

        }

        @if (Result.Message.Insurance.Any(i => !IsEmpty(i)))
        {
            <div class="insurance-section">
                <h4><span class="bi bi-credit-card me-2"></span>Insurance Information</h4>
                <div class="insurance-list">
                    @foreach (var insurance in Result.Message.Insurance.Where(i => !IsEmpty(i)))
                    {
                        var insFields = insurance.GetValues();
                        <div class="insurance-item">
                            @{
                                var setId = GetFieldValue(insFields, 1);
                                if (!string.IsNullOrWhiteSpace(setId))
                                {
                                    <div class="insurance-header">Set ID: @setId</div>
                                }
                            }
                            <div class="insurance-details">
                                @for (int i = 2; i < Math.Min(insFields.Length, 10); i++)
                                {
                                    var field = GetFieldValue(insFields, i);
                                    if (!string.IsNullOrWhiteSpace(field))
                                    {
                                        <div>Field @i: @field</div>
                                    }
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
    }
    else
    {
        <div class="no-data">
            <span class="bi bi-info-circle"></span>
            <p>No message data available</p>
        </div>
    }
</div>

@code {
    [Parameter]
    public ParsedMessageResult Result { get; set; } = null!;

    private string GetFieldValue(string[] fields, int index, string defaultValue = "")
    {
        if (index < 0 || index >= fields.Length)
            return defaultValue;
        
        var value = fields[index];
        return string.IsNullOrWhiteSpace(value) ? defaultValue : value;
    }

    private string FormatDate(string? date)
    {
        if (string.IsNullOrWhiteSpace(date))
            return "Unknown";

        if (date.Length >= 8)
        {
            try
            {
                var year = date.Substring(0, 4);
                var month = date.Substring(4, 2);
                var day = date.Substring(6, 2);
                return $"{month}/{day}/{year}";
            }
            catch
            {
                return date;
            }
        }

        return date;
    }

    private bool IsEmpty(KeryxPars.HL7.Contracts.ISegment? segment)
    {
        if (segment == null)
            return true;

        var values = segment.GetValues();
        for (int i = 1; i < values.Length; i++)
        {
            if (!string.IsNullOrWhiteSpace(values[i]))
                return false;
        }
        return true;
    }

    private string GetSegmentName(string segmentId)
    {
        return segmentId switch
        {
            "OBR" => "Observation Request",
            "OBX" => "Observation Result",
            "RXE" => "Pharmacy Encoded Order",
            "RXO" => "Pharmacy Order",
            "RXA" => "Pharmacy Administration",
            "RXD" => "Pharmacy Dispense",
            "RXG" => "Pharmacy Give",
            "NTE" => "Notes & Comments",
            "TQ1" => "Timing/Quantity",
            "ODS" => "Dietary Order",
            "ODT" => "Diet Tray",
            _ => segmentId
        };
    }

    private record FieldDisplay(string Label, string Value);

    private List<FieldDisplay> GetImportantFields(string segmentId, string[] fields)
    {
        var result = new List<FieldDisplay>();

        switch (segmentId)
        {
            case "OBR": // Observation Request
                AddIfNotEmpty(result, "Set ID", GetFieldValue(fields, 1));
                AddIfNotEmpty(result, "Placer Order#", GetFieldValue(fields, 2));
                AddIfNotEmpty(result, "Filler Order#", GetFieldValue(fields, 3));
                AddIfNotEmpty(result, "Universal Service ID", GetFieldValue(fields, 4));
                AddIfNotEmpty(result, "Requested Date/Time", GetFieldValue(fields, 7));
                break;

            case "OBX": // Observation Result
                AddIfNotEmpty(result, "Set ID", GetFieldValue(fields, 1));
                AddIfNotEmpty(result, "Value Type", GetFieldValue(fields, 2));
                AddIfNotEmpty(result, "Observation ID", GetFieldValue(fields, 3));
                AddIfNotEmpty(result, "Observation Value", GetFieldValue(fields, 5));
                AddIfNotEmpty(result, "Units", GetFieldValue(fields, 6));
                AddIfNotEmpty(result, "Reference Range", GetFieldValue(fields, 7));
                AddIfNotEmpty(result, "Abnormal Flags", GetFieldValue(fields, 8));
                break;

            case "RXE": // Pharmacy Encoded Order
                AddIfNotEmpty(result, "Give Code", GetFieldValue(fields, 2));
                AddIfNotEmpty(result, "Give Amount Min", GetFieldValue(fields, 3));
                AddIfNotEmpty(result, "Give Units", GetFieldValue(fields, 5));
                AddIfNotEmpty(result, "Give Dosage Form", GetFieldValue(fields, 6));
                break;

            case "RXO": // Pharmacy Order
                AddIfNotEmpty(result, "Requested Give Code", GetFieldValue(fields, 1));
                AddIfNotEmpty(result, "Requested Give Amount", GetFieldValue(fields, 2));
                AddIfNotEmpty(result, "Requested Give Units", GetFieldValue(fields, 4));
                break;

            case "RXA": // Pharmacy Administration
                AddIfNotEmpty(result, "Give Sub-ID", GetFieldValue(fields, 1));
                AddIfNotEmpty(result, "Admin Sub-ID", GetFieldValue(fields, 2));
                AddIfNotEmpty(result, "Date/Time Start", GetFieldValue(fields, 3));
                AddIfNotEmpty(result, "Administered Code", GetFieldValue(fields, 5));
                AddIfNotEmpty(result, "Administered Amount", GetFieldValue(fields, 6));
                break;

            case "NTE": // Notes
                AddIfNotEmpty(result, "Set ID", GetFieldValue(fields, 1));
                AddIfNotEmpty(result, "Source", GetFieldValue(fields, 2));
                AddIfNotEmpty(result, "Comment", GetFieldValue(fields, 3));
                break;

            case "ODS": // Dietary Order
                AddIfNotEmpty(result, "Type", GetFieldValue(fields, 1));
                AddIfNotEmpty(result, "Diet Code", GetFieldValue(fields, 2));
                break;

            default:
                // For unknown segments, show first few non-empty fields
                for (int i = 1; i < Math.Min(fields.Length, 6); i++)
                {
                    var value = GetFieldValue(fields, i);
                    if (!string.IsNullOrWhiteSpace(value))
                    {
                        result.Add(new FieldDisplay($"Field {i}", value));
                    }
                }
                break;
        }

        return result;
    }

    private void AddIfNotEmpty(List<FieldDisplay> list, string label, string value)
    {
        if (!string.IsNullOrWhiteSpace(value))
        {
            list.Add(new FieldDisplay(label, value));
        }
    }
}


