using System;
using System.Linq;
using KeryxPars.HL7.Mapping;
using KeryxPars.HL7.Mapping.Fluent;
using KeryxPars.HL7.Tests.Mapping.Examples;
using KeryxPars.HL7.Tests.Mapping.FluentProfiles;
using Shouldly;

namespace KeryxPars.HL7.Tests.Mapping;

/// <summary>
/// Tests for the Fluent API mapping.
/// </summary>
public class FluentApiMappingTests
{
    private const string SimpleAdtMessage = 
        "MSH|^~\\&|SENDING_APP|SENDING_FAC|RECEIVING_APP|RECEIVING_FAC|20230615143022||ADT^A01|MSG12345|P|2.5||\r" +
        "EVN|A01|20230615143020||\r" +
        "PID|1||MRN123456||DOE^JOHN^MICHAEL||19800115|M|||123 MAIN ST^APT 4B^CITYVILLE^CA^90210|||||||\r" +
        "PV1|1|I|ICU^201^A||||||||||||||||VISIT123|||||||||||||||||||||||||||||||||||||||";

    private const string EnhancedAdtMessage = 
        "MSH|^~\\&|SENDING_APP|SENDING_FAC|RECEIVING_APP|RECEIVING_FAC|20230615143022||ADT^A01|MSG12345|P|2.5||\r" +
        "EVN|A01|20230615143020||\r" +
        "PID|1||MRN123456||DOE^JOHN^ROBERT||19800115|M|||123 MAIN ST^APT 4B^CITYVILLE^CA^90210|||||||\r" +
        "PV1|1|I|ICU^201^A||||||||||||||||VISIT123|||||||||||||||||||||||||||||||||||||||";

    private const string LabResultMessage = 
        "MSH|^~\\&|LAB|LAB_FAC|EMR|EMR_FAC|20230615100000||ORU^R01|MSG001|P|2.5||\r" +
        "PID|1||PAT123456||DOE^JOHN||19800115|M|||||||||||\r" +
        "OBR|1|ORD123|SPEC456|CBC^Complete Blood Count||20230615090000|||||||||||||||||||F||\r" +
        "OBX|1|NM|WBC^White Blood Cell Count|1|7.5|10*3/uL|4.5-11.0|N|||F|||\r" +
        "OBX|2|NM|RBC^Red Blood Cell Count|1|4.8|10*6/uL|4.2-5.4|N|||F|||\r" +
        "OBX|3|NM|HGB^Hemoglobin|1|14.5|g/dL|13.5-17.5|N|||F|||\r" +
        "OBX|4|NM|HCT^Hematocrit|1|42.1|%|38.8-50.0|N|||F|||";

    [Fact]
    public void FluentApi_BasicMapping_ShouldWork()
    {
        // Arrange
        var mapper = new HL7FluentMapper();
        mapper.RegisterProfile<PatientAdmissionFluentProfile>();

        // Act
        var result = mapper.Map<PatientAdmission>(SimpleAdtMessage);

        // Assert
        result.ShouldNotBeNull();
        result.PatientId.ShouldBe("MRN123456");
        result.LastName.ShouldBe("DOE");
        result.FirstName.ShouldBe("JOHN");
        result.MiddleName.ShouldBe("MICHAEL");
    }

    [Fact]
    public void FluentApi_AddressMapping_ShouldWork()
    {
        // Arrange
        var mapper = new HL7FluentMapper();
        mapper.RegisterProfile<PatientAdmissionFluentProfile>();

        // Act
        var result = mapper.Map<PatientAdmission>(SimpleAdtMessage);

        // Assert
        result.StreetAddress.ShouldBe("123 MAIN ST");
        result.City.ShouldBe("CITYVILLE");
        result.State.ShouldBe("CA");
        result.ZipCode.ShouldBe("90210");
    }

    [Fact]
    public void FluentApi_DateTimeConversion_ShouldWork()
    {
        // Arrange
        var mapper = new HL7FluentMapper();
        mapper.RegisterProfile<PatientAdmissionEnhancedFluentProfile>();

        // Act
        var result = mapper.Map<PatientAdmissionEnhanced>(EnhancedAdtMessage);

        // Assert
        result.DateOfBirth.ShouldBe(new DateTime(1980, 1, 15));
        result.MessageDateTime.ShouldBe(new DateTime(2023, 6, 15, 14, 30, 22));
        result.EventDateTime.ShouldBe(new DateTime(2023, 6, 15, 14, 30, 20));
    }

    [Fact]
    public void FluentApi_EnumConversion_ShouldWork()
    {
        // Arrange
        var mapper = new HL7FluentMapper();
        mapper.RegisterProfile<PatientAdmissionEnhancedFluentProfile>();

        // Act
        var result = mapper.Map<PatientAdmissionEnhanced>(EnhancedAdtMessage);

        // Assert
        result.Gender.ShouldBe(Gender.M);
        result.PatientClass.ShouldBe(PatientClass.I);
    }

    [Fact]
    public void FluentApi_NestedObjects_ShouldWork()
    {
        // Arrange
        var mapper = new HL7FluentMapper();
        mapper.RegisterProfile<PatientWithNestedObjectsFluentProfile>();

        // Act
        var result = mapper.Map<PatientWithNestedObjects>(SimpleAdtMessage);

        // Assert
        result.Name.ShouldNotBeNull();
        result.Name.LastName.ShouldBe("DOE");
        result.Name.FirstName.ShouldBe("JOHN");
        result.Name.MiddleName.ShouldBe("MICHAEL");

        result.HomeAddress.ShouldNotBeNull();
        result.HomeAddress.City.ShouldBe("CITYVILLE");
        result.HomeAddress.ZipOrPostalCode.ShouldBe("90210");
    }

    [Fact]
    public void FluentApi_Collections_ShouldWork()
    {
        // Arrange
        var mapper = new HL7FluentMapper();
        mapper.RegisterProfile<LabResultFluentProfile>();

        // Act
        var result = mapper.Map<LabResult>(LabResultMessage);

        // Assert
        result.PatientId.ShouldBe("PAT123456");
        result.Observations.ShouldNotBeNull();
        result.Observations.Count.ShouldBe(4);

        var wbc = result.Observations[0];
        wbc.ObservationIdentifier.ShouldBe("WBC");
        wbc.ObservationValue.ShouldBe("7.5");
    }

    [Fact]
    public void FluentApi_RequiredField_ThrowsIfMissing()
    {
        // Arrange
        var mapper = new HL7FluentMapper();
        mapper.RegisterProfile<PatientAdmissionFluentProfile>();
        
        var messageWithoutPatientId = 
            "MSH|^~\\&|SENDING_APP|SENDING_FAC|RECEIVING_APP|RECEIVING_FAC|20230615143022||ADT^A01|MSG12345|P|2.5||\r" +
            "PID|1||||DOE^JOHN||19800115|M||||||||||";

        // Act & Assert
        Should.Throw<HL7MappingException>(() => mapper.Map<PatientAdmission>(messageWithoutPatientId));
    }

    [Fact]
    public void FluentApi_Performance_ShouldBeFast()
    {
        // Arrange
        var mapper = new HL7FluentMapper();
        mapper.RegisterProfile<PatientAdmissionEnhancedFluentProfile>();
        var iterations = 1000;

        // Act
        var sw = System.Diagnostics.Stopwatch.StartNew();
        for (int i = 0; i < iterations; i++)
        {
            _ = mapper.Map<PatientAdmissionEnhanced>(EnhancedAdtMessage);
        }
        sw.Stop();

        // Assert - should be reasonably fast even with reflection
        sw.ElapsedMilliseconds.ShouldBeLessThan(300);

        Console.WriteLine($"Fluent API: Mapped {iterations} messages in {sw.ElapsedMilliseconds}ms");
        Console.WriteLine($"Average: {sw.Elapsed.TotalMilliseconds / iterations:F4}ms per message");
    }

    [Fact]
    public void FluentApi_CanUseMultipleProfiles()
    {
        // Arrange
        var mapper = new HL7FluentMapper();
        mapper.RegisterProfile<PatientAdmissionFluentProfile>();
        mapper.RegisterProfile<LabResultFluentProfile>();

        // Act
        var patient = mapper.Map<PatientAdmission>(SimpleAdtMessage);
        var labResult = mapper.Map<LabResult>(LabResultMessage);

        // Assert
        patient.PatientId.ShouldBe("MRN123456");
        labResult.PatientId.ShouldBe("PAT123456");
    }
}
